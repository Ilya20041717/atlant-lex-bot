## Архитектурная схема (текстом)

1. Telegram Bot API  
   - Входящие сообщения от пользователей.
2. Backend (Python, aiogram)  
   - Роутеры: `handlers/*`  
   - Контент: `content/*`  
   - Сервисный слой: `services/*`  
   - Репозитории доступа к данным: `repositories/*`  
   - Мидлвари: `middlewares/*` (сессия БД, загрузка пользователя, роль)  
3. База данных (SQLite на старте / PostgreSQL в проде)  
   - Пользователи, роли, клиенты, этапы, документы, платежи, задачи, уведомления.  
4. Внешние интеграции (подключаются позже)  
   - CRM, платежные системы, автоуведомления, ИИ-модуль (не используется в MVP).

## Разграничение прав доступа

- Роль хранится в `users.role`.  
- На каждом сообщении роль подгружается в middleware.  
- Доступ к разделам ограничивается `RoleFilter`.  
- Менеджер/юрист/собственник — роли зарезервированы (интерфейсы не реализованы).

## Хранение состояний пользователя

- MVP: FSM в памяти (`MemoryStorage`).  
- Прод: Redis (`aiogram.fsm.storage.redis`) или запись состояния в БД (`user_states`),  
  чтобы гарантировать восстановление после рестарта.

## Масштабируемость под SaaS

- Мультиарендность: `organizations` + `org_id` во всех ключевых таблицах.  
- Возможность выделения схемы/БД на арендатора.  
- Очереди задач для уведомлений и интеграций (Celery/RQ/Cloud Tasks).  
- Горизонтальное масштабирование бота при хранении состояния в Redis.  
